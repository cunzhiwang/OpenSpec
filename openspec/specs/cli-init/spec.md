# CLI 初始化规范

## 目的

`openspec init` 命令应当在任何项目中创建完整的 OpenSpec 目录结构，支持多个 AI 编程助手，实现即时采用 OpenSpec 约定。

## 需求
### 需求：进度指示器

命令应当在初始化期间显示进度指示器，为每个步骤提供清晰的反馈。

#### 场景：显示初始化进度

- **当** 执行初始化步骤时
- **则** 在后台静默验证环境（除非出错否则不输出）
- **并且** 使用 ora 加载动画显示进度：
  - 显示加载动画："⠋ 正在创建 OpenSpec 结构..."
  - 然后成功："✔ OpenSpec 结构已创建"
  - 显示加载动画："⠋ 正在配置 AI 工具..."
  - 然后成功："✔ AI 工具已配置"

### 需求：目录创建

命令应当创建带有配置文件的 OpenSpec 目录结构。

#### 场景：创建 OpenSpec 结构

- **当** 执行 `openspec init` 时
- **则** 创建以下目录结构：
```
openspec/
├── config.yaml
├── specs/
└── changes/
    └── archive/
```

### 需求：AI 工具配置

命令应当使用可搜索的多选体验配置 AI 编程助手的技能和斜杠命令。

#### 场景：提示 AI 工具选择

- **当** 交互式运行时
- **则** 显示带有 OpenSpec logo 的动画欢迎屏幕
- **并且** 展示一个可搜索的多选界面，显示所有可用工具
- **并且** 用"(已配置 ✓)"指示器标记已配置的工具
- **并且** 预选已配置的工具以便于刷新
- **并且** 将已配置的工具排序显示在列表顶部
- **并且** 允许通过输入进行过滤搜索

#### 场景：选择要配置的工具

- **当** 用户选择工具并确认时
- **则** 为每个选定的工具在 `.<tool>/skills/` 目录生成技能
- **并且** 为每个选定的工具在 `.<tool>/commands/opsx/` 目录生成斜杠命令
- **并且** 创建带有默认模式设置的 `openspec/config.yaml`

### 需求：交互模式
命令应当为 AI 工具选择提供带有清晰导航说明的交互式菜单。

#### 场景：显示交互式菜单
- **当** 在全新或扩展模式下运行时
- **则** 展示一个循环选择菜单，让用户用空格键切换工具，用回车键查看选择
- **并且** 当在高亮的可选工具上按回车键且该工具尚未选中时，自动将其添加到选择中再进入查看，以便高亮的工具被配置
- **并且** 用"(已配置)"标记已配置的工具，保持禁用选项标记为"即将推出"
- **并且** 在扩展模式下将提示文案改为"您想添加或刷新哪些 AI 工具？"
- **并且** 显示内联说明，说明空格键切换工具，回车键在查看选择前选中高亮的工具

### 需求：安全检查
命令应当执行安全检查，防止覆盖现有结构并确保适当的权限。

#### 场景：检测现有初始化
- **当** `openspec/` 目录已存在时
- **则** 通知用户 OpenSpec 已初始化，跳过重新创建基本结构，进入扩展模式
- **并且** 继续到 AI 工具选择步骤，以便配置额外的工具
- **并且** 仅当用户拒绝添加任何 AI 工具时才显示现有初始化错误消息

### 需求：成功输出

命令应当在成功初始化后提供清晰、可操作的下一步建议。

#### 场景：显示成功消息

- **当** 初始化成功完成时
- **则** 显示分类摘要：
  - "已创建：<tools>" 表示新配置的工具
  - "已刷新：<tools>" 表示已配置但被更新的工具
  - 生成的技能和命令数量
- **并且** 显示入门部分，包含：
  - `/opsx:new` - 开始新变更
  - `/opsx:continue` - 创建下一个产物
  - `/opsx:apply` - 实现任务
- **并且** 显示文档和反馈链接

#### 场景：显示重启说明

- **当** 初始化成功完成且工具已创建或刷新时
- **则** 显示重启 IDE 以使斜杠命令生效的说明

### 需求：退出码

命令应当使用一致的退出码来指示不同的失败模式。

#### 场景：返回退出码

- **当** 命令完成时
- **则** 返回适当的退出码：
  - 0：成功
  - 1：一般错误（包括 OpenSpec 目录已存在时）
  - 2：权限不足（保留供将来使用）
  - 3：用户取消操作（保留供将来使用）

### 需求：额外 AI 工具初始化
`openspec init` 应当允许用户在初始设置后为新的 AI 编程助手添加配置文件。

#### 场景：在初始设置后配置额外工具
- **前提** `openspec/` 目录已存在且至少有一个 AI 工具文件
- **当** 用户运行 `openspec init` 并选择不同的支持 AI 工具时
- **则** 以与首次初始化相同的方式为该工具生成带有 OpenSpec 标记的配置文件
- **并且** 保持现有工具配置文件不变，除了需要刷新的托管部分
- **并且** 以退出码 0 退出，显示成功摘要，突出显示新添加的工具文件

### 需求：成功输出增强
`openspec init` 应当在初始化或扩展模式完成时汇总工具操作。

#### 场景：显示工具摘要
- **当** 命令成功完成时
- **则** 显示已创建、已刷新或已跳过（包括已配置跳过）的工具分类摘要
- **并且** 使用所选工具的名称个性化"下一步"标题，当没有工具时使用通用标签

### 需求：退出码调整
`openspec init` 应当将没有新原生工具选择的扩展模式视为成功刷新。

#### 场景：允许空扩展运行
- **当** OpenSpec 已初始化且用户未选择额外的原生支持工具时
- **则** 成功完成，不要求额外的工具设置
- **并且** 保留现有的 OpenSpec 结构和配置文件
- **并且** 以退出码 0 退出

### 需求：非交互模式

命令应当通过命令行选项支持非交互操作。

#### 场景：非交互式选择所有工具

- **当** 使用 `--tools all` 运行时
- **则** 自动选择所有可用的 AI 工具而不提示
- **并且** 继续技能和命令生成

#### 场景：非交互式选择特定工具

- **当** 使用 `--tools claude,cursor` 运行时
- **则** 解析逗号分隔的工具 ID
- **并且** 仅为指定工具生成技能和命令

#### 场景：非交互式跳过工具配置

- **当** 使用 `--tools none` 运行时
- **则** 仅创建 openspec 目录结构
- **并且** 跳过技能和命令生成
- **并且** 仅在满足配置创建条件时创建配置

#### 场景：无效工具规格

- **当** 使用 `--tools invalid-tool` 运行时
- **则** 以退出码 1 失败
- **并且** 显示错误，列出可用值（`all`、`none` 和支持的工具 ID）

#### 场景：保留值与工具 ID 组合

- **当** 使用 `--tools all,claude` 或 `--tools none,cursor` 运行时
- **则** 以退出码 1 失败
- **并且** 显示错误，说明保留值不能与特定工具 ID 组合

#### 场景：非交互模式下缺少 --tools

- **前提** 在非交互式执行中提示不可用
- **当** 用户运行 `openspec init` 而不带 `--tools` 时
- **则** 以退出码 1 失败
- **并且** 指示使用 `--tools all`、`--tools none` 或显式工具 ID

### 需求：技能生成

命令应当为选定的 AI 工具生成 Agent Skills。

#### 场景：为工具生成技能

- **当** 在初始化期间选择工具时
- **则** 在 `.<tool>/skills/` 下创建 9 个技能目录：
  - `openspec-explore/SKILL.md`
  - `openspec-new-change/SKILL.md`
  - `openspec-continue-change/SKILL.md`
  - `openspec-apply-change/SKILL.md`
  - `openspec-ff-change/SKILL.md`
  - `openspec-verify-change/SKILL.md`
  - `openspec-sync-specs/SKILL.md`
  - `openspec-archive-change/SKILL.md`
  - `openspec-bulk-archive-change/SKILL.md`
- **并且** 每个 SKILL.md 应当包含带有名称和描述的 YAML frontmatter
- **并且** 每个 SKILL.md 应当包含技能说明

### 需求：斜杠命令生成

命令应当为选定的 AI 工具生成 opsx 斜杠命令。

#### 场景：为工具生成斜杠命令

- **当** 在初始化期间选择工具时
- **则** 使用工具的命令适配器创建 9 个斜杠命令文件：
  - `/opsx:explore`
  - `/opsx:new`
  - `/opsx:continue`
  - `/opsx:apply`
  - `/opsx:ff`
  - `/opsx:verify`
  - `/opsx:sync`
  - `/opsx:archive`
  - `/opsx:bulk-archive`
- **并且** 使用工具特定的路径约定（例如，Claude 使用 `.claude/commands/opsx/`）
- **并且** 包含工具特定的 frontmatter 格式

### 需求：配置文件生成

命令应当创建带有模式设置的 OpenSpec 配置文件。

#### 场景：创建 config.yaml

- **当** 初始化完成时
- **并且** config.yaml 不存在时
- **则** 创建带有默认模式设置的 `openspec/config.yaml`
- **并且** 在输出中显示配置位置

#### 场景：保留现有 config.yaml

- **当** 在扩展模式下运行初始化时
- **并且** `openspec/config.yaml` 已存在时
- **则** 保留现有配置文件
- **并且** 在输出中显示"(已存在)"指示器

### 需求：实验性命令别名

命令应当保持与实验性命令的向后兼容性。

#### 场景：运行 openspec experimental

- **当** 用户运行 `openspec experimental` 时
- **则** 委托给 `openspec init`
- **并且** 命令应当在帮助输出中隐藏

## 原因

手动创建 OpenSpec 结构容易出错，会造成采用摩擦。标准化的 init 命令确保：
- 所有项目结构一致
- 始终包含正确的 AI 指令文件
- 新项目快速入门
- 从一开始就有清晰的约定
