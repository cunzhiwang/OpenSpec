# opsx-verify-skill 规范

## 目的
定义 `/opsx:verify` 行为，用于根据变更产物评估实现的完整性、正确性和一致性。

## 需求
### 需求：验证技能调用
系统应当提供 `/opsx:verify` 技能，用于根据变更产物验证实现。

#### 场景：提供变更名称进行验证
- **当** 代理执行 `/opsx:verify <change-name>` 时
- **则** 代理验证该特定变更的实现
- **且** 产生验证报告

#### 场景：不提供变更名称进行验证
- **当** 代理执行 `/opsx:verify` 而不带变更名称时
- **则** 代理提示用户从可用变更中选择
- **且** 仅显示有实现任务的变更

#### 场景：变更没有任务
- **当** 选择的变更没有 tasks.md 或任务为空时
- **则** 代理报告 "No tasks to verify"
- **且** 建议运行 `/opsx:continue` 来创建任务

### 需求：完整性验证
代理应当验证所有必需的工作已完成。

#### 场景：任务完成检查
- **当** 验证完整性时
- **则** 代理读取 tasks.md
- **且** 统计标记为 `- [x]`（完成）与 `- [ ]`（未完成）的任务
- **且** 报告完成状态并列出具体的未完成任务

#### 场景：规范覆盖检查
- **当** 验证完整性时
- **且** 增量规范存在于 `openspec/changes/<name>/specs/` 中
- **则** 代理从增量规范提取所有需求
- **且** 在代码库中搜索每个需求的实现
- **且** 报告哪些需求似乎有实现与哪些缺失

#### 场景：所有任务完成
- **当** 所有任务标记为完成时
- **则** 报告 "Tasks: N/N complete"
- **且** 将完整性维度标记为通过

#### 场景：发现未完成任务
- **当** 某些任务未完成时
- **则** 报告 "Tasks: X/N complete"
- **且** 列出每个未完成的任务
- **且** 标记为 CRITICAL 问题
- **且** 建议："Complete remaining tasks or mark as done if already implemented"

### 需求：正确性验证
代理应当验证实现是否匹配规范。

#### 场景：需求实现映射
- **当** 验证正确性时
- **则** 对于增量规范中的每个需求：
  - 在代码库中搜索实现
  - 识别相关文件和行号
  - 评估实现是否满足需求

#### 场景：场景覆盖检查
- **当** 验证正确性时
- **则** 对于增量规范中的每个场景：
  - 检查场景的条件是否在代码中处理
  - 检查是否存在覆盖该场景的测试
  - 报告覆盖状态

#### 场景：实现匹配规范
- **当** 实现似乎满足需求时
- **则** 报告哪些文件/行实现了它
- **且** 将需求标记为已覆盖

#### 场景：实现与规范偏离
- **当** 实现存在但不匹配规范意图时
- **则** 将偏离报告为 WARNING
- **且** 解释有什么不同
- **且** 建议：更新实现或更新规范以匹配现实

#### 场景：缺失实现
- **当** 未找到需求的实现时
- **则** 报告为 CRITICAL 问题
- **且** 建议："Implement requirement X" 并提供需要什么的指导

### 需求：一致性验证
代理应当验证实现是否合理并遵循设计决策。

#### 场景：Design.md 遵守检查
- **当** 验证一致性时
- **且** 变更存在 design.md
- **则** 从 design.md 提取关键决策
- **且** 验证实现是否遵循这些决策
- **且** 报告任何偏离

#### 场景：无 design.md
- **当** 验证一致性时
- **且** 不存在 design.md
- **则** 跳过设计遵守检查
- **且** 注明 "No design.md to verify against"

#### 场景：设计决策被遵循
- **当** 实现遵循设计决策时
- **则** 报告为已确认
- **且** 引用代码中的证据

#### 场景：设计决策被违反
- **当** 实现与设计决策相矛盾时
- **则** 报告为 WARNING
- **且** 解释矛盾
- **且** 建议：更新实现或更新 design.md

#### 场景：代码模式一致性
- **当** 验证一致性时
- **则** 检查新代码是否遵循现有项目模式
- **且** 将任何重大偏离标记为建议

### 需求：验证报告格式
代理应当产生结构化、优先级化的报告。

#### 场景：报告摘要
- **当** 验证完成时
- **则** 显示摘要记分卡：
  ```text
  ## Verification Report: <change-name>

  ### Summary
  | Dimension    | Status   |
  |--------------|----------|
  | Completeness | X/Y      |
  | Correctness  | X/Y      |
  | Coherence    | Followed |
  ```

#### 场景：问题优先级化
- **当** 发现问题时
- **则** 按优先级顺序分组显示：
  1. CRITICAL - 归档前必须修复（缺失实现、未完成任务）
  2. WARNING - 应该修复（与规范/设计的偏离、缺失测试）
  3. SUGGESTION - 最好修复（模式不一致、小改进）

#### 场景：可操作的建议
- **当** 报告问题时
- **则** 包含具体、可操作的修复建议
- **且** 在适用时引用相关文件和行号
- **且** 避免模糊的建议如 "consider reviewing"

#### 场景：所有检查通过
- **当** 所有维度都没有发现问题时
- **则** 显示：
  ```text
  All checks passed. Ready for archive.
  ```

#### 场景：发现严重问题
- **当** 存在 CRITICAL 问题时
- **则** 显示：
  ```text
  X critical issue(s) found. Fix before archiving.
  ```
- **且** 不建议运行归档

#### 场景：仅有警告/建议
- **当** 没有 CRITICAL 问题但存在警告时
- **则** 显示：
  ```text
  No critical issues. Y warning(s) to consider.
  Ready for archive (with noted improvements).
  ```

### 需求：灵活的产物处理
代理应当优雅地处理具有不同产物完整度的变更。

#### 场景：最小变更（仅任务）
- **当** 变更仅有 tasks.md 时
- **则** 仅验证任务完成
- **且** 跳过规范和设计检查
- **且** 注明跳过了哪些检查

#### 场景：有规范但无设计的变更
- **当** 变更有 tasks.md 和增量规范但无 design.md 时
- **则** 验证完整性和正确性
- **且** 跳过设计遵守
- **且** 仍然根据项目模式检查代码一致性

#### 场景：完整变更（所有产物）
- **当** 变更有提案、设计、规范和任务时
- **则** 执行所有验证检查
- **且** 交叉引用产物以确保一致性
