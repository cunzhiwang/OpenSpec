# CI Nix 验证规范

## 目的

在 CI 中验证 Nix flake 构建和维护脚本，以确保 Nix 用户可以可靠地安装和使用 OpenSpec。通过在每次拉取请求和推送到 main 时测试构建和 update-flake.sh 脚本，防止 Nix 支持出现回归。

## 需求
### 需求：Nix Flake 构建验证

CI 系统应当在每次拉取请求和推送到 main 时验证 Nix flake 构建成功。

#### 场景：成功的 flake 构建

- **当** 进行拉取请求或推送到 main 时
- **则** CI 应当执行 `nix build` 并验证其以退出码 0 完成
- **并且** 构建输出应当包含 openspec 二进制文件

#### 场景：Flake 构建失败

- **当** Nix flake 配置损坏时
- **则** CI 作业应当以非零退出码失败
- **并且** CI 应当阻止合并拉取请求

#### 场景：多平台支持检查

- **当** flake 声明支持多个系统时
- **则** CI 应当验证 flake 至少在 Linux（x86_64-linux）上构建

### 需求：更新脚本验证

CI 系统应当验证 update-flake.sh 脚本成功执行并产生有效输出。

#### 场景：更新脚本执行

- **当** CI 运行更新脚本验证时
- **则** 脚本应当无错误执行
- **并且** 脚本应当正确从 package.json 读取版本
- **并且** 脚本应当验证 flake.nix 使用 package.json 中的动态版本

#### 场景：使用模拟哈希的更新脚本

- **当** 在 CI 中验证更新脚本时
- **则** 脚本应当能够检测和提取正确的 pnpm 依赖哈希
- **并且** flake.nix 应当使用有效的 sha256 哈希进行更新

### 需求：CI 作业集成

Nix 验证作业应当集成到现有的 GitHub Actions 工作流中，并作为合并的必需项。

#### 场景：PR 合并要求

- **当** 创建拉取请求时
- **则** Nix 验证作业应当包含在必需检查中
- **并且** 在 Nix 验证通过之前，PR 不应当可合并

#### 场景：作业执行触发器

- **当** 代码推送到拉取请求或推送到 main 或手动触发时
- **则** Nix 验证作业应当自动执行

### 需求：本地测试支持

CI 工作流应当可以使用 `act` 工具在本地测试，以实现快速迭代。

#### 场景：使用 act 本地执行 CI

- **当** 开发者使用 Nix 验证工作流运行 `act` 时
- **则** 工作流应当在本地 Docker 环境中执行
- **并且** 开发者应当获得 Nix 构建状态的反馈，无需推送到 GitHub

#### 场景：Act 配置兼容性

- **当** 设计工作流时
- **则** 应当使用与 `act` 兼容的标准 GitHub Actions 语法
- **并且** 任何 Nix 特定设置应当在 act Docker 环境中工作

### 需求：CI 中的 Nix 安装

CI 环境应当在运行验证之前正确安装和配置 Nix。

#### 场景：Nix 安装步骤

- **当** Nix 验证作业开始时
- **则** Nix 应当使用官方 Nix 安装程序或 determinatesystems/nix-installer-action 安装
- **并且** Nix 安装应当被缓存以提高后续运行的性能

#### 场景：CI 的 Nix 配置

- **当** 在 CI 中安装 Nix 时
- **则** 应当配置为在 GitHub Actions 环境中工作
- **并且** 应当启用实验性功能（flakes、nix-command）

### 需求：CI 性能优化

Nix 验证应当优化以最小化 CI 运行时间影响。

#### 场景：可接受的运行时间

- **当** Nix 验证作业运行时
- **则** 干净运行应当在 5 分钟内完成
- **并且** 使用缓存后，后续运行应当在 3 分钟内完成

#### 场景：并行执行

- **当** 多个 CI 作业运行时
- **则** Nix 验证作业应当与其他验证作业（测试、lint）并行运行
- **并且** 不应当阻塞其他独立检查
