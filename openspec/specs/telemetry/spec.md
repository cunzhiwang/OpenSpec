# 遥测规范

## 目的

本规范定义 OpenSpec 如何收集匿名使用遥测以帮助改进工具。它管理 `src/telemetry/` 模块，处理 PostHog 集成、隐私保护事件设计、用户选择退出机制和首次运行通知显示。规范确保遥测最小化、透明并尊重用户隐私。

## 需求

### 需求：命令执行跟踪
当任何 CLI 命令执行时，系统应当向 PostHog 发送 `command_executed` 事件，仅包含命令名称和 OpenSpec 版本作为属性。

#### 场景：标准命令执行
- **当** 用户运行任何 openspec 命令时
- **则** 系统发送带有 `command` 和 `version` 属性的 `command_executed` 事件

#### 场景：子命令执行
- **当** 用户运行嵌套命令如 `openspec change apply` 时
- **则** 系统发送带有完整命令路径（例如 `change:apply`）的 `command_executed` 事件

### 需求：隐私保护事件设计
系统不应当在遥测事件中包含命令参数、文件路径、项目名称、规范内容、错误消息或 IP 地址。

#### 场景：带参数的命令
- **当** 用户运行 `openspec init my-project --force` 时
- **则** 遥测事件仅包含 `command: "init"` 和 `version: "<version>"`，不包含参数

#### 场景：IP 地址排除
- **当** 系统发送遥测事件时
- **则** 事件显式设置 `$ip: null` 以防止 IP 跟踪

### 需求：环境变量选择退出
当设置 `OPENSPEC_TELEMETRY=0` 或 `DO_NOT_TRACK=1` 环境变量时，系统应当禁用遥测。

#### 场景：OPENSPEC_TELEMETRY 选择退出
- **当** 环境中设置了 `OPENSPEC_TELEMETRY=0` 时
- **则** 系统不发送遥测事件

#### 场景：DO_NOT_TRACK 选择退出
- **当** 环境中设置了 `DO_NOT_TRACK=1` 时
- **则** 系统不发送遥测事件

#### 场景：环境变量优先
- **当** 用户之前使用过 CLI（配置存在）
- **并且** 用户设置了 `OPENSPEC_TELEMETRY=0`
- **则** 无论配置状态如何都禁用遥测

### 需求：CI 环境自动禁用
当检测到 `CI=true` 环境变量时，系统应当自动禁用遥测。

#### 场景：CI 环境检测
- **当** 环境中设置了 `CI=true` 时
- **则** 系统不发送遥测事件

#### 场景：CI 中显式启用
- **当** 设置了 `CI=true`
- **并且** 显式设置了 `OPENSPEC_TELEMETRY=1`
- **则** 遥测仍然禁用（CI 为隐私优先）

### 需求：首次运行遥测通知
系统应当在首次命令执行时显示单行遥测披露通知，在发送任何遥测之前。

#### 场景：首次命令执行
- **当** 用户运行首个 openspec 命令时
- **并且** 遥测已启用
- **则** 系统显示："注意：OpenSpec 收集匿名使用统计。选择退出：OPENSPEC_TELEMETRY=0"

#### 场景：后续命令执行
- **当** 用户已经看过通知（配置中 noticeSeen: true）
- **则** 系统不显示通知

#### 场景：遥测前通知
- **当** 显示首次运行通知时
- **则** 通知在任何遥测事件发送之前出现

### 需求：匿名用户标识
系统应当在首次遥测发送时生成随机 UUID 作为匿名标识符，存储在全局配置中。

#### 场景：首次遥测事件
- **当** 发送首个遥测事件时
- **并且** 配置中不存在 anonymousId
- **则** 系统生成随机 UUID v4 并存储在配置中

#### 场景：持久身份
- **当** 用户跨会话运行多个命令时
- **则** 所有事件使用相同的 anonymousId

#### 场景：选择退出时延迟生成
- **当** 用户在运行任何命令前选择退出
- **则** 永不生成或存储 anonymousId

### 需求：立即事件发送
系统应当使用 `flushAt: 1` 和 `flushInterval: 0` 配置立即发送遥测事件而不进行批处理。

#### 场景：事件传输时机
- **当** 命令执行时
- **则** 遥测事件立即发送，不排队进行批量传输

### 需求：优雅关闭
系统应当在 CLI 退出前调用 `posthog.shutdown()` 以确保待处理事件被刷新。

#### 场景：正常退出
- **当** 命令成功完成时
- **则** 系统在退出前等待 `shutdown()`

#### 场景：错误退出
- **当** 命令因错误失败时
- **则** 系统仍然在退出前等待 `shutdown()`

### 需求：静默失败处理
系统应当静默忽略遥测失败而不影响 CLI 功能。

#### 场景：网络失败
- **当** 遥测请求因网络错误失败时
- **则** CLI 命令正常完成，不显示错误消息

#### 场景：PostHog 中断
- **当** PostHog 服务不可用时
- **则** CLI 命令正常完成，不显示错误消息

#### 场景：关闭失败
- **当** `shutdown()` 失败或超时时
- **则** CLI 正常退出，不显示错误消息
