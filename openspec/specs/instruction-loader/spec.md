# instruction-loader 规范

## 目的
指令加载器从模式目录加载指令模板，使用元数据和参数（如变更上下文和依赖状态）验证和丰富它们，并将它们公开给下游服务，包括模板检索、参数替换和丰富。

## 需求
### 需求：模板加载
系统应当从模式目录加载模板。

#### 场景：从模式目录加载模板
- **当** 调用 `loadTemplate(schemaName, templatePath)` 时
- **则** 系统从 `schemas/<schemaName>/templates/<templatePath>` 加载模板

#### 场景：模板文件未找到
- **当** 模板文件不存在于模式的 templates 目录中时
- **则** 系统抛出带有模板路径的错误

### 需求：变更上下文加载
系统应当加载结合图和完成状态的变更上下文。

#### 场景：为现有变更加载上下文
- **当** 为现有变更调用 `loadChangeContext(projectRoot, changeName)` 时
- **则** 系统返回带有图、已完成集合、模式名称和变更信息的上下文

#### 场景：使用自定义模式加载上下文
- **当** 调用 `loadChangeContext(projectRoot, changeName, schemaName)` 时
- **则** 系统使用指定的模式而不是默认模式

#### 场景：为不存在的变更目录加载上下文
- **当** 为不存在的变更目录调用 `loadChangeContext` 时
- **则** 系统返回带有空已完成集合的上下文

### 需求：模板丰富
系统应当使用变更特定的上下文丰富模板。

#### 场景：包含产物元数据
- **当** 为产物生成指令时
- **则** 输出包含变更名称、产物 ID、模式名称和输出路径

#### 场景：包含依赖状态
- **当** 产物有依赖时
- **则** 输出显示每个依赖及其完成状态（done/missing）

#### 场景：包含已解锁产物
- **当** 生成指令时
- **则** 输出包含此产物完成后哪些产物变得可用

#### 场景：根产物指示器
- **当** 产物没有依赖时
- **则** 依赖部分指示这是根产物

### 需求：状态格式化
系统应当将变更状态格式化为可读输出。

#### 场景：所有产物已完成
- **当** 所有产物已完成时
- **则** 状态将所有产物显示为 "done"

#### 场景：混合完成状态
- **当** 部分产物已完成时
- **则** 状态将已完成显示为 "done"，就绪显示为 "ready"，阻塞显示为 "blocked"

#### 场景：阻塞产物详情
- **当** 产物被阻塞时
- **则** 状态显示哪些依赖缺失

#### 场景：包含输出路径
- **当** 格式化状态时
- **则** 每个产物显示其输出路径模式
