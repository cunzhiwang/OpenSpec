## 目的

配置文件应定义安装哪些工作流，为新用户启用精简的核心体验，同时允许高级用户自定义其工作流选择。

## 新增需求

### 需求：配置文件定义
系统应支持两个工作流配置文件：`core` 和 `custom`。

#### 场景：Core 配置文件内容
- **当** 配置文件设置为 `core`
- **则** 配置文件应包含工作流：`propose`、`explore`、`apply`、`archive`

#### 场景：Custom 配置文件内容
- **当** 配置文件设置为 `custom`
- **则** 配置文件应仅包含全局配置 `workflows` 数组中指定的工作流

### 需求：交付独立于配置文件
交付设置应控制工作流如何安装（技能、命令或两者），与安装哪些工作流分开。

#### 场景：交付选项
- **当** 配置交付时
- **则** 系统应支持三个选项：`both`（技能和命令）、`skills`（仅技能文件）、`commands`（仅命令文件）

#### 场景：Both 交付
- **当** 交付设置为 `both`
- **则** 系统应为每个工作流安装技能文件和命令文件

#### 场景：Skills-only 交付
- **当** 交付设置为 `skills`
- **则** 系统应仅为每个工作流安装技能文件
- **则** 系统不应安装命令文件

#### 场景：Commands-only 交付
- **当** 交付设置为 `commands`
- **则** 系统应仅为每个工作流安装命令文件
- **则** 系统不应安装技能文件

#### 场景：带自定义交付的 Core 配置文件
- **当** 配置文件设置为 `core`
- **且** 交付设置为 `skills`
- **则** 系统应仅将 core 工作流作为技能安装（无命令）

#### 场景：交付默认值
- **当** 全局配置中未设置交付
- **则** 系统应默认为 `both`

### 需求：通过交互式选择器配置配置文件
系统应提供配置配置文件的交互式选择器。

#### 场景：交互式配置文件配置
- **当** 用户运行 `openspec config profile`
- **则** 系统应显示交互式选择器，包含：
  - 交付选择：`skills`、`commands`、`both`
  - 所有可用工作流的工作流切换
- **则** 系统应预选当前配置值
- **则** 确认时，系统应更新全局配置
- **则** 如果选择的工作流与 core 默认值不同，系统应将配置文件设置为 `custom`
- **则** 如果选择的工作流完全匹配 core 默认值（propose、explore、apply、archive），无论交付设置如何，系统应将配置文件设置为 `core`
- **则** 系统不应修改任何项目文件
- **则** 系统应显示："配置已更新。在你的项目中运行 `openspec update` 以应用。"

#### 场景：Core 预设快捷方式
- **当** 用户运行 `openspec config profile core`
- **则** 系统应将配置文件设置为 `core`
- **则** 系统应将工作流设置为 `['propose', 'explore', 'apply', 'archive']`
- **则** 系统不应更改交付设置（保留用户偏好）
- **则** 系统不应修改任何项目文件
- **则** 系统应显示："配置已更新。在你的项目中运行 `openspec update` 以应用。"
- **则** 新配置文件在下次 `openspec init` 或 `openspec update` 运行时生效

#### 场景：在项目内运行 Config profile
- **当** 用户在 OpenSpec 项目目录内运行 `openspec config profile`
- **则** 更新全局配置后，系统应提示："现在应用到此项目？(y/n)"
- **当** 用户确认
- **则** 系统应自动运行 `openspec update`
- **则** 系统仍应显示："在你的其他项目中运行 `openspec update` 以应用。"

#### 场景：Config profile - 用户拒绝应用
- **当** 用户在 OpenSpec 项目目录内运行 `openspec config profile`
- **且** 用户拒绝"现在应用到此项目？"提示
- **则** 系统应显示："配置已更新。在你的项目中运行 `openspec update` 以应用。"
- **则** 系统应成功退出而不修改项目文件

#### 场景：Config profile 非交互式
- **当** 用户非交互式运行 `openspec config profile`（如在 CI 中，无 TTY）
- **则** 系统应显示错误："需要交互模式。使用 `openspec config profile core` 或通过环境/标志设置配置。"
- **则** 系统应以退出代码 1 退出

### 需求：配置文件设置存储在全局配置中
配置文件和交付设置应存储在现有全局配置文件（`~/.config/openspec/config.json`）中，与遥测和功能标志并列。

#### 场景：配置模式
- **当** 读取配置文件配置时
- **则** 配置应包含 `profile`（core|custom）、`delivery`（both|skills|commands）和可选的 `workflows`（工作流名称数组）

#### 场景：模式演进
- **当** 加载没有 profile/delivery 字段的配置时
- **则** 系统应使用默认值（profile=core，delivery=both）
- **且** 现有配置字段（telemetry、featureFlags）应保留

#### 场景：Config list 显示配置文件设置
- **当** 用户运行 `openspec config list`
- **则** 系统应显示 profile、delivery 和 workflows 设置
- **且** 应指示哪些值是默认 vs 显式设置

### 需求：配置是全局的，项目是显式的
配置更改不应自动传播到项目。

#### 场景：配置更新不修改项目
- **当** 用户通过 `openspec config profile` 更新配置
- **则** 系统应仅更新全局配置（`~/.config/openspec/config.json`）
- **则** 系统不应修改任何项目技能/命令文件
- **则** 现有项目保留其当前工作流文件直到用户运行 `openspec update`

### 需求：通过 update 命令应用配置更改
现有 `openspec update` 命令应将当前全局配置应用到项目。详细更新行为见 `specs/cli-update/spec.md`。

#### 场景：配置更改需要显式项目同步
- **当** 用户通过 `openspec config profile` 更新配置文件或交付
- **则** 全局配置应立即更新
- **且** 项目文件应保持不变直到为该项目运行 `openspec update`

### 需求：配置文件默认值
系统应使用 `core` 作为新用户的默认配置文件，同时通过迁移保留现有用户的工作流。

#### 场景：全局配置不存在（新用户）
- **当** 全局配置文件不存在
- **且** 项目中未安装现有工作流
- **则** 系统应表现为配置文件是 `core`

#### 场景：全局配置存在但配置文件字段缺失（新用户）
- **当** 全局配置文件存在但不包含 `profile` 字段
- **且** 项目中未安装现有工作流
- **则** 系统应表现为配置文件是 `core`

#### 场景：配置文件字段缺失但有现有工作流（现有用户迁移）
- **当** 全局配置不包含 `profile` 字段
- **且** `update` 命令检测到项目中有现有工作流文件
- **则** 系统应执行一次性迁移（详见 `specs/cli-update/spec.md`）
- **则** 系统应将配置文件设置为 `custom` 带检测到的工作流
- **则** 系统在迁移期间不应添加或移除任何工作流文件
