# template-artifact-pipeline 规范

## 目的

定义工作流模板生成的统一架构，集中工作流定义、工具能力连接、转换执行和产物同步，同时保持输出保真度。

## 新增需求

### 需求：规范工作流清单

系统应定义规范工作流清单作为生成的技能和命令产物的单一事实来源。

#### 场景：注册工作流一次

- **当** 添加或修改工作流（例如 `explore`、`ff` 或 `onboard`）时
- **则** 其规范定义应在工作流清单中注册一次
- **且** 技能/命令投影应从该清单派生
- **且** 不应需要重复的手动维护列表

#### 场景：必需的技能元数据

- **当** 在清单中定义工作流技能条目时
- **则** 它应包含必需的元数据字段（`license`、`compatibility` 和 `metadata`）
- **且** 生成应以一致的方式对所有工作流使用那些值或显式默认值

### 需求：工具配置文件注册表

系统应定义工具配置文件注册表，捕获每个工具的生成能力。

#### 场景：解析工具能力

- **当** 为选定工具生成产物时
- **则** 系统应解析声明技能路径能力、命令适配器链接和转换集的工具配置文件
- **且** 具有技能支持但没有命令适配器的工具应被显式处理而无隐式回退行为

#### 场景：能力一致性验证

- **当** 运行验证检查时
- **则** 系统应检测配置工具、配置文件定义和注册适配器之间的不匹配
- **且** 在开发/CI 中以可操作错误失败

### 需求：有序转换管道

系统应支持具有显式范围和阶段语义的有序产物转换。

#### 场景：执行 pre-adapter 和 post-adapter 转换

- **当** 生成产物时
- **则** 匹配的转换应根据阶段和优先级以确定性顺序执行
- **且** `preAdapter` 转换应在命令适配器格式化前运行
- **且** `postAdapter` 转换应在适配器格式化后运行

#### 场景：声明式应用工具特定重写

- **当** 工具需要指令重写（例如命令引用语法更改）时
- **则** 那些重写应实现为带显式适用性谓词的注册转换
- **且** 生成入口点不应实现临时重写逻辑

### 需求：共享产物同步引擎

系统应提供由所有生成入口点使用的共享产物同步引擎。

#### 场景：Init 和 update 使用同一引擎

- **当** `openspec init` 或 `openspec update` 写入技能/命令时
- **则** 两个流程应使用同一编排引擎进行规划、渲染、验证和写入产物
- **且** 行为差异应由配置驱动，而不是分开的重复循环

#### 场景：遗留升级路径复用引擎

- **当** 遗留清理触发产物重新生成时
- **则** 重新生成路径应使用同一共享引擎
- **且** 生成的输出应遵循相同的转换和验证规则

### 需求：保真度护栏

系统应强制执行防止重构期间输出漂移的护栏。

#### 场景：投影对等检查

- **当** CI 运行模板生成测试时
- **则** 它应验证清单派生的投影保持一致（工作流、命令 ID、技能目录）
- **且** 检测缺失的导出或缺失的工作流注册

#### 场景：输出对等检查

- **当** 为代表性工作流/工具组合运行对等测试时
- **则** 生成的产物应与批准的基线保持行为等效，除非有意更改
- **且** 有意更改应在显式规范/提案更新中捕获
