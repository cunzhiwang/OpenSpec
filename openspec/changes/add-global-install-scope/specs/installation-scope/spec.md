## 目的

定义 OpenSpec 生成的技能和命令的安装范围模型，包括范围偏好、有效范围解析和回退/错误语义。

## 新增需求

### 需求：安装范围偏好模型
系统应支持用户级安装范围偏好，值为 `global` 和 `project`。

#### 场景：默认安装范围
- **当** 安装范围未显式配置时
- **则** 系统应解析迁移感知默认值：
- **且** 新创建配置使用 `global`
- **且** 遗留模式演进配置使用 `project`，直到显式迁移

#### 场景：显式安装范围
- **当** 用户将安装范围配置为 `project`
- **则** 生成和更新流程应使用 `project` 作为首选范围

### 需求：按工具表面的有效范围解析
系统应根据首选范围和工具能力支持按每个工具表面（技能、命令）计算有效范围。

#### 场景：支持首选范围
- **当** 工具表面支持首选范围时
- **则** 系统应使用该范围作为有效范围

#### 场景：首选范围不支持但备用支持
- **当** 工具表面不支持首选范围
- **且** 支持备用范围
- **则** 系统应使用备用范围作为有效范围
- **且** 应为用户可见输出记录回退说明

#### 场景：无支持的范围
- **当** 工具表面既不支持 `global` 也不支持 `project`
- **则** 命令应在写入文件前失败
- **且** 应显示可操作的补救措施

### 需求：有效范围报告
当有效范围决策与首选范围不同时，系统应在命令输出中报告。

#### 场景：回退报告
- **当** 任何选定/配置的工具表面发生回退解析时
- **则** init/update 摘要应包含每个受影响工具的有效范围说明

### 需求：跨平台路径行为
安装范围解析应产生平台正确的目标路径。

#### 场景：Windows 上的全局范围路径
- **当** 有效范围是 `global`
- **且** 命令在 Windows 上运行
- **则** 解析的目标路径应使用 Windows 路径约定和分隔符
- **且** 不应直接重用 POSIX 风格的家目录相对默认值

### 需求：范围转换的清理安全性
范围转换应首先更新新目标，并安全清理旧的托管目标。

#### 场景：范围更改时托管文件的自动清理
- **当** update 或 init 为配置的工具/表面应用范围转换时
- **则** 系统应在清理前先在新有效范围写入新产物
- **且** 应仅自动移除先前有效范围中 OpenSpec 托管的文件

#### 场景：清理范围边界
- **当** 范围转换后运行清理时
- **则** 系统应保持非托管文件不变
- **且** 应将移除范围限制为受影响的工具/工作流托管路径

#### 场景：成功写入后清理失败
- **当** 新产物在新范围成功写入
- **且** 旧托管目标的清理失败
- **则** 命令应报告失败，包含剩余清理路径
- **且** 不应回滚成功写入的新范围产物
