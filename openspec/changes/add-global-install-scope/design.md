## 上下文

OpenSpec 今天假设大多数生成的产物是项目本地安装，Codex 命令提示是主要的全局例外。这种混合模型有效，但它是隐式的且用户不可配置。

请求的变更是支持用户可选择的工具技能/命令安装范围（`global` 或 `project`），为新配置默认使用 `global`，同时保留遗留的项目本地行为直到显式迁移。

## 目标/非目标

**目标：**

- 提供用户可以全局设置并按运行覆盖的单一范围偏好
- 新用户默认使用 `global` 范围
- 使安装路径解析在工具/表面之间确定性和明确
- 为尚未定义 `installScope` 的旧配置文件用户保留当前行为
- 避免静默部分安装；在输出中显示有效范围决策

**非目标：**

- 实现全局设置的项目本地配置文件支持
- 为上游位置约定未知的工具定义全局安装路径
- 在此变更中更改工作流/配置文件语义（`core`、`custom`、`delivery`）

## 决策

### 1. 全局配置中的范围模型

向全局配置添加安装范围偏好：

```ts
type InstallScope = 'global' | 'project';

interface GlobalConfig {
  // 现有字段...
  installScope?: InstallScope;
}
```

默认值：

- 新配置应显式写入 `installScope: global`。
- 没有此字段的现有配置通过模式演进继续安全加载，并且在用户显式设置 `installScope` 之前，有效默认值应解析为 `project`。

### 2. 显式工具范围支持元数据

用每个表面的可选范围支持声明扩展 `AI_TOOLS` 元数据：

```ts
interface ToolInstallScopeSupport {
  skills?: InstallScope[];
  commands?: InstallScope[];
}
```

解析规则：

1. 如果工具表面的范围支持元数据缺失，为保守的向后兼容性将其视为仅支持项目。
2. 尝试首选范围。
3. 如果不支持，在支持时使用备用范围。
4. 如果两者都不支持，以可操作的错误失败。

这启用了默认全局行为，同时对仅支持项目本地路径的工具保持安全。

### 3. 范围感知安装目标解析器

引入共享解析器工具以计算以下的有效目标路径：

- 技能根目录
- 命令输出文件

解析器输入：

- 工具 ID
- 请求的范围
- 项目根目录
- 环境上下文（`CODEX_HOME` 等）

解析器输出：

- 每个表面的有效范围
- 具体目标路径
- 用于用户可见输出的可选回退原因

平台行为：

- 解析器输出是操作系统感知的，并为当前平台标准化。
- Windows 全局目标必须使用 Windows 路径约定（例如，当 `CODEX_HOME` 未设置时，Codex 的 `%USERPROFILE%\.codex\prompts` 回退），而不是 POSIX 默认值。

### 4. 上下文感知命令适配器路径

更新命令生成契约，使适配器接收安装上下文用于路径解析。这避免了硬编码的绝对/相对假设并集中范围决策。

示例方向：

```ts
getFilePath(commandId: string, context: InstallContext): string
```

### 5. CLI 行为和用户体验

`init`：

- 默认使用配置的安装范围；如果在遗留配置中缺失，使用迁移安全的有效默认值（`project`）。
- 支持显式覆盖标志（`--scope global|project`）。
- 在交互模式下，在写入文件之前显示选定的范围和任何每工具回退决策。

`update`：

- 应用当前范围偏好（或覆盖）；如果在遗留配置中缺失，使用迁移安全的有效默认值（`project`）。
- 使用有效范围路径和最后应用的范围状态执行漂移检测。
- 在摘要输出中报告有效范围决策。

`config`：

- `openspec config profile` 交互流程包括安装范围选择。
- `openspec config list` 显示带来源注释的 `installScope`（`explicit`、`new-default` 或 `legacy-default`）。

### 6. 范围更改期间的清理安全性

当范围更改时：

- 写入发生在新的有效目标。
- 清理/移除限于相关工具/工作流 ID 的 OpenSpec 托管文件。
- 输出明确说明哪些范围位置被更新，哪些被清理。

### 7. 范围漂移状态跟踪

在项目托管状态中为每个工具/表面跟踪最后成功的有效范围。

规则：

1. 当当前解析的范围与配置的工具/表面的最后成功范围不同时检测到漂移。
2. 在任何写入开始之前，必须为所有配置的工具/表面验证范围支持。
3. 更新首先写入新解析的目标，验证完整性，然后移除先前目标的托管文件。
4. 如果新目标写入是部分的或验证失败，命令应中止旧目标清理并报告可操作的失败，包含不完整/新的和保留/旧的路径。
5. 清理失败不会回滚新写入；命令返回可操作的失败，包含要解决的剩余路径。

### 8. 与命令表面能力变更的协调

如果 `add-tool-command-surface-capabilities` 落地，规划逻辑必须一起评估范围解析和交付/能力行为（范围 × 交付 × 命令表面）。

## 风险/权衡

**风险：跨项目共享全局状态**
全局安装在项目之间共享。从一个项目更新全局产物会影响使用该工具范围的所有项目。
→ 缓解：在输出中使范围明确；保持配置文件/交付全局和确定性。

**风险：工具特定的未知全局约定**
并非所有工具都记录了稳定的全局安装位置。
→ 缓解：使用显式范围支持元数据；回退或失败而不是猜测。

**风险：适配器 API 变动**
更改适配器路径契约会触及许多文件/测试。
→ 缓解：通过适配器契约测试和现有端到端生成测试一次性迁移。

## 推出计划

1. 为安装范围添加配置模式 + 默认值。
2. 添加工具范围能力元数据和解析器工具。
3. 升级命令适配器契约和生成器路径管道。
4. 将范围感知行为集成到 init/update。
5. 添加文档和测试覆盖。
